## Урок 7. Spring Security. Работа с JWT. Защита от основных видов атак

### <u>Термины, используемые в лекции</u>

**Spring Security** – это мощный и настраиваемый механизм безопасности для приложений Spring, позволяющий интегрировать различные средства аутентификации и авторизации.

**JWT (JSON Web Token)** – это компактное, URL-безопасное средство представления между двумя сторонами. Они обычно используются для передачи данных аутентификации и авторизации.

**Bearer Token** – тип токена авторизации, который предоставляется клиентом при каждом запросе. Это часто JWT.

**Authentication (Аутентификация)** – процесс определения, кто вы.

**Authorization (Авторизация)** – процесс определения, что вам разрешено делать.

**OAuth2** – протокол авторизации, который позволяет приложениям получать ограниченный доступ к аккаунтам пользователя на внешних сервисах.

**CSRF (Cross-Site Request Forgery)** – вид атаки, при которой злоумышленник может заставить пользователя выполнить нежелательное действие в веб-приложении, в котором он аутентифицирован.

**CORS (Cross-Origin Resource Sharing)** – механизм, который позволяет разрешить или запретить веб-страницам выполнение запросов к серверу с другого источника.

**XSS (Cross-Site Scripting)** – вид атаки, при которой злоумышленник может вставить злонамеренный код в веб-страницы

**SQL Injection** – вид атаки, при которой злоумышленник может выполнять произвольные SQL-запросы в базе данных через вводимые пользователем данные.

**Principal** – текущий пользователь или системный процесс, который выполняет действие в системе.

**Role-Based Access Control (RBAC)** – метод определения доступа на основе ролей пользователей в системе.

**Filter Chain** – цепочка фильтров в Spring Security, которая обрабатывает входящие HTTP-запросы для выполнения различных задач безопасности.

**Authentication Provider** – компонент в Spring Security, который определяет, как пользователи будут аутентифицированы.

### <u>Важность информационной безопасности</u>

Итак, давайте начнем с простого вопроса: почему информационная безопасность так важна для серверных приложений? На этот вопрос есть довольно простой ответ: данные. Каждое серверное приложение обрабатывает данные, а в некоторых случаях эти данные могут быть чрезвычайно ценными. Это могут быть личные данные пользователей, финансовые данные, секретные корпоративные документы, и так далее.

Если эти данные попадут в неправильные руки из-за недостаточной безопасности нашего серверного приложения, последствия могут быть катастрофическими. Мы говорим о возможных штрафах за нарушение законов о защите данных, потере доверия со стороны клиентов, ущербе для репутации компании и многом другом. 

Помимо этого, если наше приложение является частью большей системы, например, микросервисной архитектуры, то уязвимость в одном приложении может стать угрозой для всей системы. Например, злоумышленник, получивший доступ к одному сервису, может использовать его в качестве “трамплина” для атаки на другие сервисы.

В общем, игнорирование вопросов информационной безопасности может привести к серьезным последствиям. Именно поэтому каждый разработчик должен знать основы безопасности и применять их на практике.

Может быть, немного сложно понять абстрактные опасности, связанные с игнорированием вопросов безопасности, поэтому давайте посмотрим на несколько реальных примеров нарушения безопасности и их последствий.

Один из самых известных примеров - это компания Yahoo. В 2013 году они были жертвой крупнейшего в истории нарушения безопасности, которое затронуло около 3 миллиардов пользовательских аккаунтов. Воры получили доступ к именам, адресам электронной почты, номерам телефонов, датам рождения и, в некоторых случаях, зашифрованным паролям. В итоге Yahoo была вынуждена выплатить $50 млн в качестве компенсации своим пользователям.

Еще один пример – это компания Equifax, одна из трех крупнейших кредитных бюро в США. В 2017 году злоумышленники получили доступ к личным данным около 147 миллионов людей, включая имена, номера социального страхования, даты рождения, адреса и номера водительских удостоверений. Это нарушение безопасности обошлось Equifax в $575 миллионов штрафов и выплат по искам.

Эти примеры показывают, что последствия нарушений безопасности могут быть дорогостоящими и разрушительными для бизнеса. Именно поэтому так важно уделять должное внимание безопасности в процессе разработки серверных приложений.

### <u>Аутентификация</u>

Одним из первых шагов для обеспечения безопасности нашего серверного приложения является понимание и применение аутентификации. Аутентификация - это процесс подтверждения идентичности пользователя. В своей основе это ответ на вопрос: “Ты действительно тот, за кого ты себя выдаешь?”

Давайте приведем несколько примеров аутентификации, чтобы лучше понять, как она работает.
1. Вход в систему с использованием имени пользователя и пароля: это, возможно, самый распространенный пример аутентификации. Когда вы вводите свое имя пользователя и пароль, система проверяет эти данные, чтобы убедиться, что вы - это вы.
2. Вход с помощью отпечатка пальца или распознавания лица на вашем смартфоне: это пример биометрической аутентификации, где ваши уникальные физические характеристики используются для подтверждения вашей личности.
3. Ввод PIN-кода или ответ на секретный вопрос: это еще один способ аутентификации, который часто используется в банковских системах или системах восстановления паролей.

Все эти примеры являются формами аутентификации, и все они имеют общую цель – убедиться, что пользователь, пытающийся получить доступ к системе, действительно является тем, кем он утверждает быть. Это важный первый шаг для обеспечения безопасности нашего серверного приложения.

### <u>Авторизация</u>

Теперь, когда мы знаем, кто наш пользователь благодаря аутентификации, следующий шаг – это определить, что он может делать в нашей системе. Здесь на сцену выходит авторизация.

Авторизация – это процесс, в рамках которого определяется, какие действия разрешены пользователю в системе. Если аутентификация отвечает на вопрос “кто?”, то авторизация отвечает на вопрос “что может?”.

Давайте рассмотрим примеры авторизации в реальной жизни:
1. В компьютерной игре пользователь может быть аутентифицирован как игрок, но авторизован только для выполнения определенных действий, таких как перемещение персонажа, использование предметов, но не для изменения параметров игры или добавления новых уровней.
2. В банковской системе клиент может быть аутентифицирован как владелец счета, но авторизован только для выполнения операций, таких как проверка баланса, совершение платежей, но не для увеличения баланса счета без выполнения денежного перевода.
3. В интернет-магазине покупатель может быть аутентифицирован как зарегистрированный пользователь, но авторизован только для просмотра товаров, добавления их в корзину, совершения покупки, но не для изменения цен на товары или добавления новых товаров в каталог.

Как видите, авторизация является важным элементом безопасности серверных приложений, потому что она позволяет контролировать доступ пользователя к функциям и данным приложения.

### <u>Принципы безопасности</u>

Когда мы говорим о безопасности серверных приложений, существует несколько ключевых принципов, которые мы должны учесть. Они определяют наш подход к обеспечению безопасности и помогают нашим приложениям оставаться защищенными от угроз.
1. Минимальные привилегии: Принцип минимальных привилегий говорит о том, что каждый пользователь (или процесс) должен иметь минимально необходимые права для выполнения своих функций. Это означает, что пользователи не должны иметь доступа к функциям или данным, которые они не нуждаются для выполнения своих задач. Это прямо связано с авторизацией, о которой мы говорили ранее.
2. Защита данных: Данные, особенно чувствительные, такие как личная информация пользователей, должны быть защищены во все время. Это может включать в себя шифрование данных, использование безопасных протоколов передачи данных и обеспечение безопасного хранения данных.
3. Аудит и мониторинг: Всегда важно иметь возможность отслеживать и анализировать действия в вашем приложении. Это может помочь выявить подозрительную активность и быстро реагировать на возможные угрозы.
4. Обработка ошибок и исключений: Неправильная обработка ошибок может привести к утечке информации, которая может быть использована злоумышленниками. Важно убедиться, что ваше приложение корректно обрабатывает ошибки и исключения, не раскрывая лишней информации.
5. Обновления и патчи: Уязвимости и ошибки безопасности могут появляться в любой системе. Поэтому важно регулярно обновлять и применять патчи к вашему приложению и его зависимостям.

Все эти принципы вместе обеспечивают многоуровневую защиту для вашего приложения и помогают снизить риск нарушения безопасности.

### <u>Важность принципов</u>

Серверное приложение без применения вышеупомянутых принципов безопасности – это как автомобиль без замка и страховки. Да, он может ездить, но в любой момент его могут украсть или он может попасть в аварию, и вы останетесь ни с чем. Поэтому, когда мы разрабатываем серверное приложение, мы не можем просто игнорировать эти принципы безопасности.

Понимание и применение принципов минимальных привилегий, защиты данных, ограничения доступа и защиты от атак – это не просто “хорошая практика”. Это абсолютная необходимость.

Без аутентификации и авторизации мы не сможем гарантировать, что пользователи нашего приложения - это те, за кого они себя выдают, и что они могут делать только то, что допустимо в рамках их привилегий. Без защиты данных мы рискуем потерять или раскрыть важную информацию. Без защиты от атак мы становимся легкой мишенью для злоумышленников.

Подводя итог, понимание и применение этих принципов безопасности - это ключ к созданию надежных и защищенных серверных приложений. Это то, что отделяет профессиональных разработчиков от новичков. И это то, что мы сегодня учимся делать.

### <u>Что такое Spring Security</u>

Теперь, когда мы разобрали основные понятия и принципы безопасности, давайте поговорим о том, что же такое Spring Security и как он может нам помочь.

Spring Security – это фреймворк безопасности для Java-приложений. Представьте его как высокотехнологичный охранник, который следит за входами и выходами в ваш замок (ваше приложение) и следит за тем, чтобы все гости (пользователи) вели себя прилично.

Основные компоненты Spring Security - это:
1. Аутентификация: Как мы обсуждали ранее, аутентификация - это процесс проверки личности пользователя. Spring Security предоставляет широкий спектр механизмов аутентификации, таких как форма входа, LDAP, OAuth и другие.
2. Авторизация: После того, как пользователь аутентифицирован, Spring Security контролирует доступ к различным частям приложения. Это можно настроить на уровне URL или методов, обеспечивая гибкий и мощный механизм контроля доступа.
3. Защита от атак: Spring Security также обеспечивает защиту от самых распространенных типов атак, таких как CSRF (межсайтовая подделка запроса), XSS (межсайтовый скриптинг) и Session Fixation.
4. Шифрование паролей: Spring Security поддерживает различные механизмы шифрования паролей, что помогает обеспечить безопасное хранение и обработку паролей.

Все эти компоненты вместе образуют мощный инструмент для обеспечения безопасности вашего серверного приложения. По сути, Spring Security управляет всей политикой безопасности вашего приложения, обеспечивая защиту от несанкционированного доступа и атак.

### <u>JSON Web Token (JWT)</u>

Поговорим теперь о том, что такое JSON Web Token или JWT и как он используется в Spring Security.

JWT – это стандарт, который определяет способ безопасной передачи информации между двумя сторонами в виде JSON-объекта. Эта информация может быть подтверждена и доверена, потому что она цифрово подписана. Подумайте об этом как о специальном паспорте для ваших пользователей, который они могут использовать, чтобы доказать, кто они и что они могут делать в вашем приложении.

Так зачем нам это нужно? Ну, в некоторых случаях, особенно когда у нас есть много сервисов, которым нужно обмениваться информацией о пользователе, JWT может быть очень полезен. Вместо того, чтобы каждый раз аутентифицировать пользователя в каждом сервисе, мы можем просто передать этот “паспорт” и сервис сможет узнать, кто этот пользователь и что он может делать.

В Spring Security JWT обычно используется вместе с OAuth 2.0 для аутентификации и авторизации. Схема обычно такова:
1. Пользователь аутентифицируется с помощью своих учетных данных.
2. После успешной аутентификации сервер создает JWT, который содержит уникальные данные пользователя, и отправляет его обратно пользователю.
3. Пользователь сохраняет этот JWT и отправляет его в заголовке Authorization с каждым последующим запросом.
4. Сервер проверяет JWT в каждом запросе, чтобы аутентифицировать пользователя и определить его права доступа.

В целом, JWT предоставляет нам способ безопасного обмена информацией между сервером и клиентом, что является важной частью безопасности нашего серверного приложения.

### <u>Настройка Spring Security</u>

**Шаг 1: Добавление зависимости**

Первое, что нам нужно сделать - добавить зависимость Spring Security в наш проект. Если вы используете Maven, вам нужно добавить следующую зависимость в ваш pom.xml:
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

**Шаг 2: Создание класса конфигурации безопасности**

Затем мы должны создать класс, который будет конфигурировать наши настройки безопасности. Этот класс должен быть аннотирован @EnableWebSecurity и расширять WebSecurityConfigurerAdapter. Вот пример:
```java
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .anyRequest().authenticated()
            .and()
            .httpBasic();
    }

    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth
            .inMemoryAuthentication()
            .withUser("user").password(passwordEncoder().encode("password")).roles("USER");
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```
В этом классе мы говорим Spring Security, что мы хотим аутентифицировать любой запрос и использовать базовую HTTP аутентификацию. Мы также настраиваем в памяти аутентификацию с одним пользователем.

**Шаг 3: Тестирование нашей конфигурации безопасности**

Теперь, когда у нас есть настройки безопасности, мы можем их протестировать. Для этого мы можем создать простой контроллер, который возвращает какой-нибудь текст, и попробовать получить доступ к нему.
```java
@RestController
public class HelloController {
    
    @GetMapping("/hello")
    public String hello() {
        return "Hello, world!";
    }
}
```

Теперь, если вы попытаетесь открыть http://localhost:8080/hello в браузере, вы должны увидеть диалоговое окно, запрашивающее имя пользователя и пароль.

Если вы введете имя пользователя “user” и пароль “password”, вы должны увидеть сообщение “Hello, world!”.

Вот и все! Вы только что настроили Spring Security в своем Spring проекте. Конечно, это очень простой пример, и в реальном проекте вам потребуется более сложная конфигурация. Но это хорошая отправная точка для начала работы с Spring Security.

### <u>Различные виды атак</u>

Давайте рассмотрим некоторые из самых распространенных типов атак, которые мы можем столкнуться при разработке серверных приложений, и узнаем, как Spring Security помогает нам противостоять этим угрозам.
1. CSRF (межсайтовая подделка запроса): Это атака, при которой злоумышленник заставляет жертву выполнить нежелательные функции на веб-сайте, в котором они аутентифицированы. Spring Security предотвращает атаки CSRF, используя синхронный маркер, который проверяется с каждым запросом на изменение состояния.
2. XSS (межсайтовый скриптинг): Это атака, при которой злоумышленник вставляет злонамеренный скрипт в веб-страницу, который затем выполняется в браузере жертвы. Хотя защита от XSS обычно включает эскейпинг и проверку входных данных на стороне сервера и клиента, Spring Security предоставляет дополнительные заголовки безопасности, которые помогают защитить от определенных видов атак XSS.
3. SQL-инъекции: Это атака, при которой злоумышленник вставляет злонамеренные SQL-запросы в ввод пользователя, который затем выполняется в базе данных. В то время как защита от SQL-инъекций в основном связана с валидацией входных данных и использованием параметризованных запросов или ORM, Spring Security также помогает уменьшить риск, обеспечивая хорошие практики аутентификации и авторизации.
4. Атаки с перехватом сессии (Session Hijacking): Злоумышленник может попытаться перехватить сессию пользователя и использовать ее для доступа к системе. Spring Security предоставляет механизмы для управления и защиты сессий, включая защиту от фиксации сессии и механизмы для автоматического выхода из системы.

Это только некоторые из атак, которые Spring Security помогает нам противостоять. Помните, безопасность - это не одноразовое действие, а процесс. Всегда следите за новыми угрозами и лучшими практиками в области безопасности.

### <u>Практика</u>